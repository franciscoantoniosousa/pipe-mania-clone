(()=>{const e=document.querySelector("canvas"),t=e.getContext("2d"),i=document.querySelector("#timeElement"),s=document.querySelector("#distanceElement"),r=document.querySelector("#scoreElement");e.width=innerWidth,e.height=innerHeight;const n=["","./images/base-pipes/4-connector.png","./images/base-pipes/bottom-left-curve.png","./images/base-pipes/bottom-right-curve.png","./images/base-pipes/top-left-curve.png","./images/base-pipes/top-right-curve.png","./images/base-pipes/horizontal.png","./images/base-pipes/vertical.png","./images/base-pipes/blocked-pipe.png","./images/base-pipes/start-to-right.png","./images/base-pipes/start-to-left.png","./images/base-pipes/start-to-bottom.png","./images/base-pipes/start-to-top.png","./images/background.png","./images/filled-pipes/4-connector-filled.png","./images/filled-pipes/4-connector-horizontal-half.png","./images/filled-pipes/4-connector-vertical-half.png","./images/filled-pipes/bottom-left-curve-filled.png","./images/filled-pipes/bottom-right-curve-filled.png","./images/filled-pipes/top-left-curve-filled.png","./images/filled-pipes/top-right-curve-filled.png","./images/filled-pipes/horizontal-filled.png","./images/filled-pipes/vertical-filled.png","./images/filled-pipes/start-to-right-filled.png","./images/filled-pipes/start-to-left-filled.png","./images/filled-pipes/start-to-bottom-filled.png","./images/filled-pipes/start-to-top-filled.png"];function o(e,t){return Math.floor(Math.random()*(t-e+1)+e)}class a{static cellWidth=40;static cellHeight=40;constructor({position:e,src:t,type:i}){this.position=e,this.width=38,this.height=38;const s=new Image;s.src=t,s.onload=()=>{this.image=s};const r=new Image;r.src=n[this.getPipeWithWaterImage(i)],r.onload=()=>{this.imageFilled=r},this.withWater=!1,this.type=i,this.alreadyFilled=!1}getPipeWithWaterImage(e){switch(console.log("trying to get filled water pipe"),e){case 1:return!1===this.alreadyFilled?(this.alreadyFilled=!0,h.currentPipe.direction===direction.Up||h.currentPipe.direction===direction.Down?16:15):14;case 2:return 17;case 3:return 18;case 4:return 19;case 5:return 20;case 6:return 21;case 7:return 22;case 9:return 23;case 10:return 24;case 11:return 25;case 12:return 26}}draw(){const e=this.withWater?this.imageFilled:this.image;e?t.drawImage(e,this.position.x,this.position.y,this.width,this.height):(t.fillStyle="rgb(255, 201, 14)",t.fillRect(this.position.x,this.position.y,this.width,this.height))}resize(e,t){}}class c{constructor({position:e}){this.position=e,this.width=a.cellWidth,this.height=a.cellHeight,this.moved=!1}draw(){t.lineWidth=3,t.strokeStyle="red",t.strokeRect(this.position.x*a.cellWidth-1,this.position.y*a.cellHeight-1,this.width,this.height)}update(){this.moved&&(this.moved=!1),this.draw()}}const h=new class{constructor(){this.countdownTimer=20,this.currentPipe={x:0,y:0,direction:0},this.gameGrid=[],this.gameStarted=!1,this.grid=[[13,13,0,0,0,0,0,0,0,0,0],[0,13,0,0,0,0,0,0,0,0,0],[0,13,0,0,0,0,0,0,0,0,0],[0,13,0,0,0,0,0,0,0,0,0],[0,13,0,0,0,0,0,0,0,0,0],[13,13,0,0,0,0,0,0,0,0,0],[13,13,0,0,0,0,0,0,0,0,0]],this.loadingNextLevel=!1,this.player=new c({position:{x:5,y:5}}),this.nextPipes=[],this.remainingDistance=o(4,20),this.score=0,this.stopCountDown=!1,this.updateQueue=!1,this.isGameOver=!1}addPipe(){let e=o(1,7);this.nextPipes.push(e),console.log("Number of pipes",this.nextPipes.length),this.updateQueue=!0}canReceiveWater(e,t){switch(console.log("Direction",t," Type",e),e){case 1:switch(t){case 1:return this.currentPipe.direction=1,!0;case 0:return this.currentPipe.direction=0,!0;case 2:return this.currentPipe.direction=2,!0;case 3:return this.currentPipe.direction=3,!0}break;case 2:switch(t){case 0:case 3:return!1;case 1:return this.currentPipe.direction=3,!0;case 2:return this.currentPipe.direction=0,!0}break;case 3:switch(t){case 0:case 2:return!1;case 1:return this.currentPipe.direction=2,!0;case 3:return this.currentPipe.direction=0,!0}break;case 4:switch(t){case 0:return this.currentPipe.direction=3,!0;case 2:return this.currentPipe.direction=1,!0;case 1:case 3:return!1}break;case 5:switch(t){case 0:return this.currentPipe.direction=2,!0;case 3:return this.currentPipe.direction=1,!0;case 1:case 2:return!1}break;case 6:switch(t){case 1:case 0:return!1;case 2:return this.currentPipe.direction=2,!0;case 3:return this.currentPipe.direction=3,!0}break;case 7:switch(t){case 1:return this.currentPipe.direction=1,!0;case 0:return this.currentPipe.direction=0,!0;case 2:case 3:return!1}break;case 8:return console.log("Clogged Pipe"),!1;case 9:case 10:case 11:case 12:return console.log("Starting Pipe"),!1;default:return console.log("There is no pipe on this cell"),!1}}drawPipeQueue(){console.log("New Pipe in queue drawn"),this.gameGrid[11]=new a({position:{x:0,y:a.cellHeight},src:n[this.nextPipes[3]],type:this.nextPipes[3]}),this.gameGrid[22]=new a({position:{x:0,y:2*a.cellHeight},src:n[this.nextPipes[2]],type:this.nextPipes[2]}),this.gameGrid[33]=new a({position:{x:0,y:3*a.cellHeight},src:n[this.nextPipes[1]],type:this.nextPipes[1]}),this.gameGrid[44]=new a({position:{x:0,y:4*a.cellHeight},src:n[this.nextPipes[0]],type:this.nextPipes[0]}),this.updateQueue=!1}gameOver(){r.innerHTML="",s.innerHTML="",i.innerHTML="GAME OVER! Press Anywhere to restart the game!"}getNextPipeInStream(){console.log("trying to fill next pipe");let e=11*this.currentPipe.y+this.currentPipe.x;switch(this.gameGrid[e].withWater=!0,this.currentPipe.direction){case 1:this.currentPipe.y+1>=7&&(this.isGameOver=!0);break;case 0:this.currentPipe.y-1<0&&(this.isGameOver=!0);break;case 2:this.currentPipe.x-1<2&&(this.isGameOver=!0);break;case 3:this.currentPipe.x+1>=11&&(this.isGameOver=!0)}if(console.log("Check if current pipe is sending water out of the game grid:",this.isGameOver),this.isGameOver&&!1===this.loadingNextLevel)return console.log("Game over, sent water out of grid"),void this.gameOver();let t,i={x:0,y:0};switch(this.currentPipe.direction){case 1:t=this.grid[this.currentPipe.y+1][this.currentPipe.x],i.x=this.currentPipe.x,i.y=this.currentPipe.y+1;break;case 0:t=this.grid[this.currentPipe.y-1][this.currentPipe.x],i.x=this.currentPipe.x,i.y=this.currentPipe.y-1;break;case 2:t=this.grid[this.currentPipe.y][this.currentPipe.x-1],i.x=this.currentPipe.x-1,i.y=this.currentPipe.y;break;case 3:t=this.grid[this.currentPipe.y][this.currentPipe.x+1],i.x=this.currentPipe.x+1,i.y=this.currentPipe.y}if(console.log("next pipe coords: ",i.x,i.y),!1===this.canReceiveWater(t,this.currentPipe.direction))return this.isGameOver=!0,void(!1===this.loadingNextLevel&&(console.log("Game Over, the next pipe cannot receive water from the previous pipe",this.isGameOver),this.gameOver()));console.log("Next Pipe was filled with water!!!"),this.currentPipe.x=i.x,this.currentPipe.y=i.y,this.score+=100,this.remainingDistance--,r.innerHTML=`Score: ${this.score}`,s.innerHTML=`Distance: ${this.remainingDistance}`,this.remainingDistance<=0&&!1===this.loadingNextLevel&&(this.stopCountDown=!0,this.nextLevel())}nextLevel(){for(console.log("Next Level"),this.loadingNextLevel=!0;!1===this.isGameOver;)this.getNextPipeInStream();this.isGameOver=!1,this.gameGrid.forEach((e=>{e.type>=1&&e.type<=7&&!1===e.withWater&&(console.log("Penalized 50 for not using a pipe"),this.score-=50)})),r.innerHTML="",s.innerHTML="";const e=setInterval((()=>{console.log("countDown: ",this.countdownTimer),i.innerHTML=`Going to next level in: ${this.countdownTimer}`,this.countdownTimer<=0?(clearInterval(e),this.restartGame(!0)):this.countdownTimer--}),1e3)}restartGame(e){this.countdownTimer=20,this.currentPipe={x:0,y:0,direction:0},this.gameGrid=[],this.gameStarted=!1,this.grid=[[13,13,0,0,0,0,0,0,0,0,0],[0,13,0,0,0,0,0,0,0,0,0],[0,13,0,0,0,0,0,0,0,0,0],[0,13,0,0,0,0,0,0,0,0,0],[0,13,0,0,0,0,0,0,0,0,0],[13,13,0,0,0,0,0,0,0,0,0],[13,13,0,0,0,0,0,0,0,0,0]],this.loadingNextLevel=!1,this.player=new c({position:{x:5,y:5}}),this.nextPipes=[],this.remainingDistance=o(4,20),!1===e&&(this.score=0),this.stopCountDown=!1,this.updateQueue=!1,this.isGameOver=!1,this.startGame()}setPipePosition(e,t){let i=Math.floor(e/a.cellWidth),s=Math.floor(t/a.cellHeight);if(i>=2&&i<11&&s>=0&&s<7){for(let e=8;e<=12;e++)if(this.grid[s][i]===e)return void console.log("Cannot place pipe in this position, its a blocked pipe or starting pipe");this.grid[s][i]=this.nextPipes.shift(),this.addPipe();let e=11*s+i;this.gameGrid[e]=new a({position:{x:a.cellWidth*i,y:a.cellHeight*s},src:n[this.grid[s][i]],type:this.grid[s][i]}),console.log("Pipe was played on coords:",s,i)}}startCountdown(){const e=setInterval((()=>{this.isGameOver?clearInterval(e):(console.log("countDown: ",this.countdownTimer),i.innerHTML=`Time Left: ${this.countdownTimer}`,this.countdownTimer<=0?(clearInterval(e),this.startWaterFlow()):this.countdownTimer--)}),1e3)}startGame(){r.innerHTML=`Score: ${this.score}`,s.innerHTML=`Distance: ${this.remainingDistance}`,i.innerHTML=`Time Left: ${this.countdownTimer}`,this.stopCountDown=!1,console.log("Initialize");const e=o(0,4);for(let t=0;t<e;t++){let e=o(0,6),t=o(2,10);this.grid[e][t]=8,console.log("blockedCell",e,t)}let t=o(9,12),c=!1;for(;!1===c;){let e=o(0,5),i=o(2,10);if(8!==this.grid[e+1][i]){let s=!1;switch(t){case 9:let t=i+1;console.log("next column: ",t),t<11&&8!==this.grid[e][t]&&(s=!0);break;case 10:let r=i-1;r>=2&&8!==this.grid[e][r]&&(s=!0);break;case 11:let n=e+1;n>0&&8!==this.grid[n][i]&&(s=!0);break;case 12:let o=e-1;o>=0&&8!==this.grid[o][i]&&(s=!0)}if(s){switch(this.grid[e][i]=t,this.currentPipe.y=e,this.currentPipe.x=i,t){case 9:this.currentPipe.direction=3;break;case 10:this.currentPipe.direction=2;break;case 11:this.currentPipe.direction=1;break;case 12:this.currentPipe.direction=0}console.log("Starting pipe of type: ",t,". was set on position: ",e,i,"with starting direction: ",this.currentPipe.direction),c=!0}else console.log("pipe type: ",t,"could not place pipe here:",i,e,"water would flow out of the map")}else console.log("Could not set initial pipe here")}for(let e=0;e<4;e++)this.addPipe();this.gameStarted=!0,this.grid.forEach(((e,t)=>{e.forEach(((e,i)=>{this.gameGrid.push(new a({position:{x:a.cellWidth*i,y:a.cellHeight*t},src:n[e],type:e}))}))})),this.startCountdown()}startWaterFlow(){console.log("StartWaterFlow");const e=setInterval((()=>{if(this.isGameOver)clearInterval(e);else{if(console.log("water flow countDown: ",this.countdownTimer),i.innerHTML=`Time Left: ${this.countdownTimer}`,this.isGameOver||this.stopCountDown)return console.log("Game Over, stop water flow timer"),void clearInterval(e);this.countdownTimer<=0?(this.countdownTimer=3,this.getNextPipeInStream()):this.countdownTimer--}}),1e3)}update(){if(!1!==this.gameStarted){this.player.update(),this.gameStarted&&this.updateQueue&&this.drawPipeQueue();for(const e in this.gameGrid)this.gameGrid[e].draw()}}};!function i(){requestAnimationFrame(i),t.clearRect(0,0,e.width,e.height),h.update()}(),window.addEventListener("mousedown",(e=>{h.gameStarted&&!1===h.isGameOver?h.setPipePosition(e.clientX+-160,e.clientY+-160):(console.log("Started Game on Click!"),h.restartGame(!1))})),window.addEventListener("mousemove",(e=>{if(h.gameStarted){let t=Math.floor((e.clientX+-160)/a.cellWidth),i=Math.floor((e.clientY+-160)/a.cellHeight);t>=2&&t<11&&i>=0&&i<7&&(h.player.position.x=t,h.player.position.y=i,h.player.moved=!0)}!1===h.isGameOver&&!1===h.gameStarted&&(r.innerHTML="",s.innerHTML="",i.innerHTML="Press Anywhere to start the game!")})),window.addEventListener("resize",(()=>{const i=window.innerWidth,s=window.innerHeight;h.gameGrid.forEach((e=>e.resize(i,s))),t.clearRect(0,0,e.width,e.height),h.gameGrid.forEach((e=>e.draw()))}))})();